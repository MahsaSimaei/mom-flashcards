<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Mom's Flashcards</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Google Fonts: Quicksand for body, Dancing Script for title -->
  <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@500;700&family=Dancing+Script:wght@700&display=swap" rel="stylesheet">
  <style>
    /* ... (same as your CSS above, omitted for brevity) ... */
    /* Add below for quiz and matching grid navigation */
    .quiz-type-bar {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
      justify-content: center;
    }
    .quiz-type-btn {
      background: var(--accent);
      color: #444;
      border: 2px solid var(--pastel-blue);
      border-radius: 10px;
      font-size: 1em;
      font-family: 'Quicksand', Arial, sans-serif;
      padding: 7px 15px;
      cursor: pointer;
      font-weight: bold;
      transition: background 0.15s, color 0.13s, border 0.13s;
    }
    .quiz-type-btn.active, .quiz-type-btn:focus {
      background: var(--pink);
      color: var(--strong-pink);
      border: 2px solid var(--strong-pink);
    }
    .quiz-mc-list {
      list-style: none;
      padding: 0;
      margin: 0 0 10px 0;
      display: flex;
      flex-direction: column;
      gap: 11px;
      width: 96%;
    }
    .quiz-mc-btn {
      background: var(--quiz-neutral);
      color: #234;
      border: 2px solid #bbc;
      border-radius: 10px;
      font-size: 1.07em;
      cursor: pointer;
      font-family: 'Quicksand', Arial, sans-serif;
      font-weight: 600;
      padding: 13px 11px;
      transition: background 0.12s, color 0.11s, border 0.11s;
    }
    .quiz-mc-btn.correct {
      background: var(--easy-green);
      color: #fff;
      border: 2px solid var(--easy-green);
    }
    .quiz-mc-btn.wrong {
      background: var(--hard-red);
      color: #fff;
      border: 2px solid var(--hard-red);
    }
    .quiz-mc-btn.disabled {
      opacity: 0.7;
      pointer-events: none;
    }
    /* Matching navigation */
    .matching-nav {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
      justify-content: center;
    }
    .matching-nav-btn {
      background: var(--accent);
      color: #444;
      border: 2px solid var(--pastel-blue);
      border-radius: 10px;
      font-size: 1em;
      font-family: 'Quicksand', Arial, sans-serif;
      padding: 7px 15px;
      cursor: pointer;
      font-weight: bold;
      transition: background 0.15s, color 0.13s, border 0.13s;
    }
    .matching-nav-btn.active, .matching-nav-btn:focus {
      background: var(--pink);
      color: var(--strong-pink);
      border: 2px solid var(--strong-pink);
    }
  </style>
</head>
<body>
  <!-- ... header, sidepanel, etc. as before ... -->
  <div class="container">
    <div class="main-content">
      <!-- Mode Nav Bar -->
      <div id="mode-bar">
        <button id="flashcard-mode-btn" class="mode-nav-btn active">Flashcards</button>
        <button id="quiz-mode-btn" class="mode-nav-btn">Quiz</button>
        <button id="matching-mode-btn" class="mode-nav-btn">Matching Game</button>
      </div>
      <!-- Language Toggle -->
      <div id="lang-toggle-row" style="margin-bottom: 12px;">
        <button id="toggle-lang-btn" class="mode-btn" style="min-width:190px">
          Show English ‚Üí Spanish
        </button>
      </div>
      <!-- Shuffle Mode Button -->
      <div class="buttons" style="margin-bottom: 0.7em;">
        <button id="shuffle-btn" class="mode-btn">Shuffle / Random Mode</button>
      </div>
      <!-- Mode Switcher -->
      <div class="buttons" style="margin-bottom:0.7em;">
        <button id="mode-all" class="mode-btn active">All Cards</button>
        <button id="mode-difficult" class="mode-btn">Difficult Cards</button>
      </div>
      <!-- Flashcard area (same as before) ... -->
      <div id="flashcard-area">
        <div id="flashcard" tabindex="0">Click to show answer</div>
        <div id="counter"></div>
        <div class="buttons">
          <button id="prev-btn" aria-label="Previous card">&lt; Prev</button>
          <button id="flip-btn" aria-label="Flip card">Flip</button>
          <button id="next-btn" aria-label="Next card">Next &gt;</button>
        </div>
        <div class="buttons">
          <button id="easy-btn" class="easy-btn" aria-label="Mark card as Easy">Easy üëç</button>
          <button id="hard-btn" class="hard-btn" aria-label="Mark card as Difficult">Difficult üòÖ</button>
        </div>
      </div>
      <!-- Quiz area -->
      <div id="quiz-area">
        <div class="quiz-type-bar">
          <button id="quiz-type-mc" class="quiz-type-btn active">Test (Multiple Choice)</button>
          <button id="quiz-type-write" class="quiz-type-btn">Write Answer</button>
        </div>
        <div id="quiz-question"></div>
        <ul id="quiz-mc-list" class="quiz-mc-list" style="display:none"></ul>
        <input id="quiz-input" type="text" autocomplete="off" placeholder="Type your answer here...">
        <button id="quiz-submit-btn">Submit</button>
        <div id="quiz-feedback"></div>
        <div id="quiz-progress"></div>
        <div id="quiz-score"></div>
        <button id="quiz-exit-btn" class="mode-btn" style="margin-top:15px;">Back to Flashcards</button>
      </div>
      <!-- Matching area -->
      <div id="matching-area">
        <div class="matching-nav">
          <button id="matching-prev" class="matching-nav-btn">&lt; Prev 8</button>
          <button id="matching-next" class="matching-nav-btn">Next 8 &gt;</button>
        </div>
        <div id="matching-score"></div>
        <div class="match-grid">
          <div class="match-col" id="match-left"></div>
          <div class="match-col" id="match-right"></div>
        </div>
        <div id="matching-end-message"></div>
        <button id="matching-exit-btn" class="mode-btn" style="margin-top:12px;">Back to Flashcards</button>
      </div>
      <!-- Import/Export Area (same as before) ... -->
      <details id="import-area">
        <summary>Edit or Import Cards</summary>
        <p style="font-size:1.05em;margin:8px 0 2px 0;">Paste your cards below in <strong>Front side,Back side</strong> format (one per line):</p>
        <textarea id="import" spellcheck="false" rows="8"></textarea>
        <br>
        <button id="import-btn">Import Cards</button>
        <button id="reset-btn" type="button">Reset to Default</button>
      </details>
    </div>
    <!-- ... stats etc. as before ... -->
    <div class="side-panel">
      <!-- ... stats unchanged ... -->
      <div id="stats">
        <div class="stats-grid">
          <div class="stat-item">
            <strong id="stat-reviewed">0</strong>
            <span class="stat-label">Reviewed</span>
            <div class="progress-bar-wrap" title="Card Progress">
              <div class="progress-bar-inner" id="progress-reviewed"></div>
            </div>
          </div>
          <div class="stat-item">
            <strong id="stat-correct">0%</strong>
            <span class="stat-label">Accuracy</span>
            <div class="progress-bar-wrap" title="Accuracy">
              <div class="progress-bar-inner" id="progress-accuracy"></div>
            </div>
          </div>
          <div class="stat-item">
            <strong id="stat-difficult">0</strong>
            <span class="stat-label">Difficult</span>
            <div class="progress-bar-wrap" title="Difficult Cards">
              <div class="progress-bar-inner" id="progress-difficult"></div>
            </div>
          </div>
          <div class="stat-item">
            <strong id="stat-mode">All</strong>
            <span class="stat-label">Mode</span>
          </div>
        </div>
      </div>
    </div>
  </div>
  <script>
    // --- STORAGE KEYS ---
    const STORAGE_KEY_CARDS = 'mom_flashcards_cards_v1';
    const STORAGE_KEY_STATS = 'mom_flashcards_stats_v1';

    // --- DEFAULT CARDS ---
    const defaultCardsText = `
the brake didn't work: ÿ™ÿ±ŸÖÿ≤ ⁄©ÿßÿ± ŸÜŸÖ€å‚Äå⁄©ÿ±ÿØ,El freno no funcion√≥
I'm running a fever,Tengo fiebre
It just came out of the oven,Acaba de salir del horno
This shirt looks good on me?,¬øMe queda bien esta camisa?
Hold on a minute!,¬°Espera un minuto!
Nephew,Sobrino
Fountain,Fuente
The brake didn't work,El freno no funcion√≥
I neither smoke nor drink,No fumo ni bebo
jacket pocket,bolsillo de la chaqueta
make friend,Hacer amiga
the closet ATM,el cajero autom√°tico del armario
zucchini,calabac√≠n
I'm heading home,voy a casa
Could you say that again please?,¬øPodr√≠as decirlo de nuevo?
I was wondering if I could borrow your notes,¬øPuedo prestar tus notas?
Could you give me a hand?,¬øPodr√≠as echarme una mano? ¬øMe puedes ayudar?
I'm sorry to hear that,Lo siento mucho
I'll let you know,Te lo avisar√©
I will call you back,Te llamar√© de nuevo
I can't hear you,No te puedo escuchar
I get off work at 6,Mi trabajo termina a las 6
I'm coming to pick you up,Estoy en camino para recogerte
Nonsense,Sin sentido
as we age,a medida que envejecemos
Sesame,S√©samo
companion,compa√±era
a small handful,un peque√±o pu√±ado
rely,confiar
miracle,milagro
had eased,se hab√≠a aliviado
soak stir and sip,remojar, remover y beber
pumpkin seeds,semillas de calabaza
resilience,resiliencia
Stillness,Quietud
embody,encarnar
Hemp seeds,semillas de c√°√±amo
sauce,salsa
sesame paste,ÿÆŸÖ€åÿ± ⁄©ŸÜÿ¨ÿØ
grace,gracia
humble way,manera humilde
manera humilde,perseguir a la juventud
dye,te√±ir
curly hair,cabello rizado, ŸÖŸà€å ŸÅÿ±ŸÅÿ±€å
follow your doctor's advice,Siga los consejos de su m√©dico
long time no see,mucho tiempo sin verlo
How's it going?,¬øC√≥mo va todo?
How have you been?,¬øC√≥mo has estado?
I think so too.,Yo tambi√©n lo creo.
I'm not sure about that.,No estoy seguro de eso.
that sounds great,Suena genial.
I'm looking forward to it.,Estoy deseando que llegue.
no worries,No te preocupes
would you like me to call him,¬øQuieres que lo llame?
Do you mind if I open the door,¬øTe importa si abro la puerta?
I'd be happy to help you.,Estar√≠a encantado de ayudarte.
I'm running late.,Voy con retraso.
I'll be there in 10 minutes.,Estar√© all√≠ en 10 minutos.
what are you up to today?,¬øQu√© est√°s haciendo hoy?
not much just relaxing at home.,No mucho, solo descansando en casa.
Let's catch up soon.,Pong√°monos al d√≠a pronto.
I'll get back to you,Me pondr√© en contacto contigo enseguida.
what do you mean?,¬øQu√© quieres decir?
let me think about it,D√©jame pensarlo
that makes sense.,Eso tiene sentido.
I don't no idea,No tengo ni idea
that's a good point.,Ese es un buen punto.
it was nice talking to you.,Fue agradable hablar contigo.
take care,Cu√≠date
see you around,Nos vemos
keep in touch,mantenerse en contacto
fairly well,bastante bien, ŸÜÿ≥ÿ®amente bien
at length my wish was realized.,Al final, mi deseo se hizo realidad.
that makes no sense at all.,Eso no tiene ning√∫n sentido.
I can't get the lid off.,No puedo quitar la tapa.
half a loaf is better than none.,Medio pan es mejor que nada.
you bet!,Apuesto a que s√≠!
jogging,correr
it's coming along,Est√° saliendo adelante
    `.trim();

    // --- CARD PARSING ---
    function parseCards(text) {
      return text.split('\n').map(line => {
        // Allow commas in back, so only first comma splits
        let [front, ...backArr] = line.split(',');
        let back = backArr.join(',').trim();
        return { front: front.trim(), back: back, id: Math.random().toString(36).slice(2,12) };
      }).filter(card => card.front && card.back);
    }

    // --- STORAGE: Load & Save ---
    function loadCards() {
      let data = localStorage.getItem(STORAGE_KEY_CARDS);
      if (!data) return parseCards(defaultCardsText);
      try {
        const arr = JSON.parse(data);
        return arr.map(card => ({
          front: card.front,
          back: card.back,
          id: card.id || Math.random().toString(36).slice(2,12)
        }));
      } catch { return parseCards(defaultCardsText); }
    }
    function saveCards(cards) {
      localStorage.setItem(STORAGE_KEY_CARDS, JSON.stringify(cards));
    }
    function loadStats(cards) {
      let data = localStorage.getItem(STORAGE_KEY_STATS);
      let stats = {};
      if (data) {
        try { stats = JSON.parse(data); } catch { stats = {}; }
      }
      for (let c of cards) {
        if (!stats[c.id]) stats[c.id] = { reviewed: 0, correct: 0, wrong: 0, difficult: false };
      }
      Object.keys(stats).forEach(cid=>{
        if (!cards.find(c=>c.id===cid)) delete stats[cid];
      });
      return stats;
    }
    function saveStats(stats) {
      localStorage.setItem(STORAGE_KEY_STATS, JSON.stringify(stats));
    }

    // --- STATE ---
    let cards = loadCards();
    let stats = loadStats(cards);
    let mode = 'all'; // 'all' or 'difficult'
    let current = 0;
    let flipped = false;
    let showEnglishFront = true;
    let shuffleMode = false;
    let appMode = 'flashcard'; // 'flashcard', 'quiz', 'matching'
    let quizState = null;
    let matchingState = null;

    // --- ELEMENTS ---
    const flashcardArea = document.getElementById('flashcard-area');
    const flashcard = document.getElementById('flashcard');
    const counter = document.getElementById('counter');
    const prevBtn = document.getElementById('prev-btn');
    const nextBtn = document.getElementById('next-btn');
    const flipBtn = document.getElementById('flip-btn');
    const easyBtn = document.getElementById('easy-btn');
    const hardBtn = document.getElementById('hard-btn');
    const importArea = document.getElementById('import');
    const importBtn = document.getElementById('import-btn');
    const resetBtn = document.getElementById('reset-btn');
    const statReviewed = document.getElementById('stat-reviewed');
    const statCorrect = document.getElementById('stat-correct');
    const statDifficult = document.getElementById('stat-difficult');
    const statMode = document.getElementById('stat-mode');
    const modeAllBtn = document.getElementById('mode-all');
    const modeDiffBtn = document.getElementById('mode-difficult');
    const progressReviewed = document.getElementById('progress-reviewed');
    const progressAccuracy = document.getElementById('progress-accuracy');
    const progressDifficult = document.getElementById('progress-difficult');
    const toggleLangBtn = document.getElementById('toggle-lang-btn');
    const shuffleBtn = document.getElementById('shuffle-btn');
    // Mode nav
    const flashcardModeBtn = document.getElementById('flashcard-mode-btn');
    const quizModeBtn = document.getElementById('quiz-mode-btn');
    const matchingModeBtn = document.getElementById('matching-mode-btn');
    // Quiz elements
    const quizArea = document.getElementById('quiz-area');
    const quizQuestion = document.getElementById('quiz-question');
    const quizInput = document.getElementById('quiz-input');
    const quizSubmitBtn = document.getElementById('quiz-submit-btn');
    const quizFeedback = document.getElementById('quiz-feedback');
    const quizProgress = document.getElementById('quiz-progress');
    const quizScore = document.getElementById('quiz-score');
    const quizExitBtn = document.getElementById('quiz-exit-btn');
    // Matching elements
    const matchingArea = document.getElementById('matching-area');
    const matchLeft = document.getElementById('match-left');
    const matchRight = document.getElementById('match-right');
    const matchingScore = document.getElementById('matching-score');
    const matchingEndMsg = document.getElementById('matching-end-message');
    const matchingExitBtn = document.getElementById('matching-exit-btn');

    // --- HELPERS ---
    function difficultList() {
      return cards.filter(card => stats[card.id]?.difficult);
    }
    function getCardList() {
      if (mode === 'all') return cards;
      return difficultList();
    }
    function cardsToText() {
      return cards.map(card => `${card.front},${card.back}`).join('\n');
    }
    function shuffleArray(array) {
      let arr = array.slice();
      for (let i = arr.length - 1; i > 0; i--) {
        let j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }
    function normalize(str) {
      return str.trim().toLowerCase().replace(/\s+/g, ' ');
    }
    // --- FLASHCARD LOGIC ---
    function showCard(idx) {
      if (appMode !== 'flashcard') return;
      let list = getCardList();
      if (list.length === 0) {
        flashcard.textContent = "No cards in this mode.";
        counter.textContent = '';
        return;
      }
      current = (idx + list.length) % list.length;
      flipped = false;
      flashcard.classList.remove('flipped');
      const card = list[current];
      flashcard.style.opacity = 0;
      setTimeout(() => {
        flashcard.textContent = showEnglishFront ? card.front : card.back;
        counter.textContent = `Card ${current + 1} of ${list.length}`;
        flashcard.classList.remove('flipped');
        flashcard.style.animation = "none";
        void flashcard.offsetWidth;
        flashcard.style.animation = null;
        flashcard.style.opacity = 1;
      }, 170);
    }
    function flipCard() {
      if (appMode !== 'flashcard') return;
      let list = getCardList();
      if (!list.length) return;
      flipped = !flipped;
      flashcard.classList.toggle('flipped', flipped);
      const card = list[current];
      flashcard.style.opacity = 0;
      setTimeout(() => {
        if (flipped) flashcard.textContent = showEnglishFront ? card.back : card.front;
        else flashcard.textContent = showEnglishFront ? card.front : card.back;
        flashcard.style.animation = "none";
        void flashcard.offsetWidth;
        flashcard.style.animation = null;
        flashcard.style.opacity = 1;
      }, 150);
    }
    function nextCard() {
      let list = getCardList();
      if (list.length === 0) return;
      if (shuffleMode) {
        let idx;
        do {
          idx = Math.floor(Math.random() * list.length);
        } while (list.length > 1 && idx === current);
        showCard(idx);
      } else {
        showCard(current + 1);
      }
    }
    function prevCard() {
      let list = getCardList();
      if (list.length === 0) return;
      if (shuffleMode) {
        let idx;
        do {
          idx = Math.floor(Math.random() * list.length);
        } while (list.length > 1 && idx === current);
        showCard(idx);
      } else {
        showCard(current - 1);
      }
    }
    function markEasy() {
      let list = getCardList();
      if (!list.length) return;
      let c = list[current];
      stats[c.id].reviewed += 1;
      stats[c.id].correct += 1;
      stats[c.id].difficult = false;
      saveStats(stats);
      updateStatsPanel();
      nextCard();
    }
    function markHard() {
      let list = getCardList();
      if (!list.length) return;
      let c = list[current];
      stats[c.id].reviewed += 1;
      stats[c.id].wrong += 1;
      stats[c.id].difficult = true;
      saveStats(stats);
      updateStatsPanel();
      nextCard();
    }
    // --- STATS PANEL ---
    function updateStatsPanel() {
      let total = cards.length;
      let reviewed = Object.values(stats).reduce((a, s) => a + s.reviewed, 0);
      let correct = Object.values(stats).reduce((a, s) => a + s.correct, 0);
      let wrong = Object.values(stats).reduce((a, s) => a + s.wrong, 0);
      let difficult = cards.filter(c => stats[c.id]?.difficult).length;
      let percent = reviewed === 0 ? 0 : Math.round(100 * correct / reviewed);
      statReviewed.textContent = reviewed;
      statCorrect.textContent = percent + '%';
      statDifficult.textContent = difficult;
      statMode.textContent = mode === 'all' ? 'All' : 'Difficult';
      modeAllBtn.classList.toggle('active', mode === 'all');
      modeDiffBtn.classList.toggle('active', mode === 'difficult');
      let reviewedPerc = total ? Math.min(100, Math.round((reviewed/total)*100)) : 0;
      progressReviewed.style.width = reviewedPerc + "%";
      progressAccuracy.style.width = percent + "%";
      let difficultPerc = total ? Math.min(100, Math.round((difficult/total)*100)) : 0;
      progressDifficult.style.width = difficultPerc + "%";
    }
    // --- MODE SWITCH ---
    function setMode(newMode) {
      mode = newMode;
      updateStatsPanel();
      showCard(0);
    }
    // --- APP MODE SWITCH (Flashcards/Quiz/Matching) ---
    function setAppMode(newMode) {
      appMode = newMode;
      // Mode nav highlight
      flashcardModeBtn.classList.toggle('active', appMode === 'flashcard');
      quizModeBtn.classList.toggle('active', appMode === 'quiz');
      matchingModeBtn.classList.toggle('active', appMode === 'matching');
      // Show/hide UI
      flashcardArea.style.display = appMode === 'flashcard' ? '' : 'none';
      quizArea.classList.toggle('active', appMode === 'quiz');
      matchingArea.classList.toggle('active', appMode === 'matching');
      if (appMode === 'flashcard') {
        showCard(current);
      } else if (appMode === 'quiz') {
        startQuiz();
      } else if (appMode === 'matching') {
        startMatching();
      }
    }
    // --- QUIZ GAME LOGIC ---
   let quizType = "mc"; // or "write"
    let quizPage = 0;
    let matchingPage = 0;
    const QUIZ_BATCH = 8;

    // Quiz type switching
    document.getElementById('quiz-type-mc').onclick = function() {
      quizType = "mc";
      this.classList.add("active");
      document.getElementById('quiz-type-write').classList.remove("active");
      startQuiz();
    };
    document.getElementById('quiz-type-write').onclick = function() {
      quizType = "write";
      this.classList.add("active");
      document.getElementById('quiz-type-mc').classList.remove("active");
      startQuiz();
    };

    // --- QUIZ GAME LOGIC (paging, MC & Write) ---
    function startQuiz() {
      let list = getCardList();
      if (list.length === 0) {
        quizArea.innerHTML = "<div style='color:#b44'>No cards in this mode.</div><button id='quiz-exit-btn2' class='mode-btn' style='margin-top:15px;'>Back to Flashcards</button>";
        document.getElementById('quiz-exit-btn2').onclick = () => setAppMode('flashcard');
        return;
      }
      // Only show a batch of 8 cards per quiz "page"
      quizPage = 0;
      quizState = {
        questions: [],
        index: 0,
        correct: 0,
        wrong: 0,
        answered: [],
      };
      makeQuizBatch();
    }
    function makeQuizBatch() {
      let list = shuffleArray(getCardList());
      let start = quizPage * QUIZ_BATCH;
      let end = Math.min(list.length, start + QUIZ_BATCH);
      quizState.questions = list.slice(start, end);
      quizState.index = 0;
      quizState.correct = 0;
      quizState.wrong = 0;
      quizState.answered = [];
      showQuizQuestion();
    }
    function showQuizQuestion() {
      const list = quizState.questions;
      const idx = quizState.index;
      document.getElementById("quiz-mc-list").style.display = quizType === "mc" ? "" : "none";
      quizInput.style.display = quizType === "write" ? "" : "none";
      quizSubmitBtn.style.display = quizType === "write" ? "" : "none";
      if (idx >= list.length) {
        quizQuestion.textContent = "Quiz Finished!";
        document.getElementById("quiz-mc-list").innerHTML = "";
        quizInput.style.display = "none";
        quizSubmitBtn.style.display = "none";
        quizProgress.textContent = "";
        quizScore.textContent = `Score: ${quizState.correct}/${list.length}`;
        quizFeedback.textContent = "";

        // Show Next 8 if more remain
        let allCards = getCardList();
        if ((quizPage+1)*QUIZ_BATCH < allCards.length) {
          quizScore.innerHTML += `<br><button id="quiz-next8-btn" class="mode-btn" style="margin-top:10px;">Next 8 &gt;</button>`;
          document.getElementById("quiz-next8-btn").onclick = () => { quizPage++; makeQuizBatch(); };
        }
        if (quizPage > 0) {
          quizScore.innerHTML += `<br><button id="quiz-prev8-btn" class="mode-btn" style="margin-top:10px;">&lt; Prev 8</button>`;
          document.getElementById("quiz-prev8-btn").onclick = () => { quizPage--; makeQuizBatch(); };
        }
        return;
      }
      quizFeedback.textContent = '';
      quizScore.textContent = '';
      quizProgress.textContent = `Question ${idx+1} of ${list.length}`;
      if (quizType === "write") {
        quizInput.value = '';
        quizInput.focus();
        quizQuestion.textContent = showEnglishFront ? list[idx].front : list[idx].back;
      } else {
        // Multiple choice
        let choices = [showEnglishFront ? list[idx].back : list[idx].front];
        let pool = getCardList()
          .filter(c=>c.id!==list[idx].id)
          .map(c=>showEnglishFront?c.back:c.front);
        shuffleArray(pool);
        while (choices.length < 4 && pool.length > 0) {
          let opt = pool.pop();
          if (!choices.includes(opt)) choices.push(opt);
        }
        shuffleArray(choices);
        quizQuestion.textContent = showEnglishFront ? list[idx].front : list[idx].back;
        let ul = document.getElementById("quiz-mc-list");
        ul.innerHTML = "";
        choices.forEach(choice => {
          let li = document.createElement("li");
          let btn = document.createElement("button");
          btn.textContent = choice;
          btn.className = "quiz-mc-btn";
          btn.onclick = function() {
            let correctAnswer = showEnglishFront ? list[idx].back : list[idx].front;
            if (normalize(choice) === normalize(correctAnswer)) {
              btn.classList.add("correct");
              quizFeedback.textContent = "Correct!";
              quizFeedback.className = "correct";
              quizState.correct++;
              stats[list[idx].id].reviewed++;
              stats[list[idx].id].correct++;
              stats[list[idx].id].difficult = false;
            } else {
              btn.classList.add("wrong");
              quizFeedback.textContent = `Wrong! Correct answer: ${correctAnswer}`;
              quizFeedback.className = "wrong";
              quizState.wrong++;
              stats[list[idx].id].reviewed++;
              stats[list[idx].id].wrong++;
              stats[list[idx].id].difficult = true;
            }
            saveStats(stats); updateStatsPanel();
            // Disable all buttons
            ul.querySelectorAll("button").forEach(b => {
              b.disabled = true; b.classList.add("disabled");
            });
            setTimeout(()=>{ quizState.index++; showQuizQuestion(); }, 1200);
          };
          li.appendChild(btn);
          ul.appendChild(li);
        });
      }
    }
    quizSubmitBtn.onclick = function() {
      const list = quizState.questions;
      const idx = quizState.index;
      const card = list[idx];
      let correctAnswer = showEnglishFront ? card.back : card.front;
      let userAns = quizInput.value;
      if (normalize(userAns) === normalize(correctAnswer)) {
        quizFeedback.textContent = "Correct!";
        quizFeedback.className = "correct";
        quizState.correct++;
        stats[card.id].reviewed++;
        stats[card.id].correct++;
        stats[card.id].difficult = false;
      } else {
        quizFeedback.textContent = `Wrong! Correct answer: ${correctAnswer}`;
        quizFeedback.className = "wrong";
        quizState.wrong++;
        stats[card.id].reviewed++;
        stats[card.id].wrong++;
        stats[card.id].difficult = true;
      }
      saveStats(stats); updateStatsPanel();
      quizState.index++;
      setTimeout(showQuizQuestion, 1100);
    };
    quizInput.onkeypress = function(e) { if (e.key === "Enter") quizSubmitBtn.onclick(); };
    quizExitBtn.onclick = function() { setAppMode('flashcard'); };

    // --- MATCHING GAME LOGIC (8 cards at a time) ---
    let matchingBatch = [];
    document.getElementById("matching-prev").onclick = function() {
      if (matchingPage > 0) { matchingPage--; startMatching(); }
    };
    document.getElementById("matching-next").onclick = function() {
      let all = getCardList();
      if ((matchingPage+1)*QUIZ_BATCH < all.length) { matchingPage++; startMatching(); }
    };
    function startMatching() {
      let list = shuffleArray(getCardList());
      matchingPage = Math.max(0, Math.min(matchingPage, Math.floor((list.length-1)/QUIZ_BATCH)));
      let start = matchingPage * QUIZ_BATCH;
      let end = Math.min(list.length, start + QUIZ_BATCH);
      matchingBatch = list.slice(start, end);
      let left = shuffleArray(matchingBatch.map(c=>({id:c.id, txt:showEnglishFront?c.front:c.back})));
      let right = shuffleArray(matchingBatch.map(c=>({id:c.id, txt:showEnglishFront?c.back:c.front})));
      matchingState = {
        left, right,
        leftSel: null,
        rightSel: null,
        matched: [],
        tries: 0,
        total: left.length,
        ended: false
      };
      matchingScore.textContent = `Score: 0/${left.length}`;
      matchingEndMsg.textContent = '';
      renderMatching();
    }
    function renderMatching() {
      matchLeft.innerHTML = '';
      matchRight.innerHTML = '';
      const st = matchingState;
      st.left.forEach((item, idx) => {
        let btn = document.createElement('button');
        btn.className = 'match-btn';
        if (st.leftSel === idx) btn.classList.add('selected');
        if (st.matched.includes(item.id)) btn.classList.add('matched');
        btn.textContent = item.txt;
        btn.disabled = st.matched.includes(item.id) || st.ended;
        btn.onclick = function() {
          st.leftSel = idx;
          st.rightSel = null;
          renderMatching();
        };
        matchLeft.appendChild(btn);
      });
      st.right.forEach((item, idx) => {
        let btn = document.createElement('button');
        btn.className = 'match-btn';
        if (st.rightSel === idx) btn.classList.add('selected');
        if (st.matched.includes(item.id)) btn.classList.add('matched');
        btn.textContent = item.txt;
        btn.disabled = st.matched.includes(item.id) || st.ended;
        btn.onclick = function() {
          if (st.leftSel === null || st.matched.includes(item.id)) return;
          st.rightSel = idx;
          let leftID = st.left[st.leftSel].id, rightID = item.id;
          if (leftID === rightID) {
            st.matched.push(leftID);
            matchingScore.textContent = `Score: ${st.matched.length}/${st.total}`;
            st.leftSel = null;
            st.rightSel = null;
            if (st.matched.length === st.total) {
              st.ended = true;
              matchingEndMsg.textContent = "Game finished! Well done!";
            }
            renderMatching();
          } else {
            stats[leftID].difficult = true; stats[item.id].difficult = true;
            stats[leftID].wrong = (stats[leftID].wrong||0)+1;
            stats[item.id].wrong = (stats[item.id].wrong||0)+1;
            saveStats(stats); updateStatsPanel();
            let leftBtns = matchLeft.querySelectorAll('.match-btn');
            let rightBtns = matchRight.querySelectorAll('.match-btn');
            leftBtns[st.leftSel].classList.add('incorrect');
            rightBtns[idx].classList.add('incorrect');
            setTimeout(()=>{
              leftBtns[st.leftSel].classList.remove('incorrect');
              rightBtns[idx].classList.remove('incorrect');
              st.leftSel = null; st.rightSel = null;
              renderMatching();
            }, 600);
          }
        };
        matchRight.appendChild(btn);
      });
    }
    matchingExitBtn.onclick = function() { setAppMode('flashcard'); };

    // --- UI EVENTS as before ---
    modeAllBtn.onclick = () => { mode = 'all'; updateStatsPanel(); showCard(0); };
    modeDiffBtn.onclick = () => { mode = 'difficult'; updateStatsPanel(); showCard(0); };
    prevBtn.onclick = prevCard;
    nextBtn.onclick = nextCard;
    flipBtn.onclick = flipCard;
    flashcard.onclick = flipCard;
    flashcard.onkeypress = (e) => { if (e.key === ' ' || e.key === 'Enter') flipCard(); };
    easyBtn.onclick = markEasy;
    hardBtn.onclick = markHard;
    toggleLangBtn.onclick = () => {
      showEnglishFront = !showEnglishFront;
      toggleLangBtn.textContent = showEnglishFront ? "Show English ‚Üí Spanish" : "Show Spanish ‚Üí English";
      if (appMode === 'flashcard') showCard(current);
      if (appMode === 'quiz') startQuiz();
      if (appMode === 'matching') startMatching();
    };
    shuffleBtn.onclick = () => {
      shuffleMode = !shuffleMode;
      shuffleBtn.classList.toggle('active', shuffleMode);
      shuffleBtn.textContent = shuffleMode ? "Random Mode ON" : "Shuffle / Random Mode";
    };
    importBtn.onclick = () => {
      const newCards = parseCards(importArea.value);
      if (newCards.length) {
        cards = newCards.map(c => ({ ...c, id: Math.random().toString(36).slice(2,12) }));
        saveCards(cards);
        stats = loadStats(cards);
        saveStats(stats);
        mode = 'all';
        updateStatsPanel();
        showCard(0);
        alert(`Imported ${cards.length} cards!`);
      } else {
        alert("No valid cards found. Please check your format.");
      }
    };
    resetBtn.onclick = () => {
      if (confirm("Are you sure you want to reset to the default cards? All current cards will be replaced.")) {
        cards = parseCards(defaultCardsText);
        saveCards(cards);
        stats = loadStats(cards);
        saveStats(stats);
        mode = 'all';
        updateStatsPanel();
        showCard(0);
        importArea.value = cardsToText();
        alert("Reset to default cards!");
      }
    };
    flashcardModeBtn.onclick = () => setAppMode('flashcard');
    quizModeBtn.onclick = () => setAppMode('quiz');
    matchingModeBtn.onclick = () => setAppMode('matching');
    importArea.value = cardsToText();
    updateStatsPanel();
    setAppMode('flashcard');
  </script>
</body>
</html>
